# 關於實現

## Liber語言的編譯

Librian使用「Liber語言」書寫劇本。  
<small>(這名字當然是我現編的……)</small>

Liber的寫法接近真實的劇本和自然語言，特點是易讀易寫。

設計Liber語言的文法時，發現現實的劇本幾乎是三型文法——   
因此沒有採用一般語言的編譯手段，而使用了基於正則表達式的簡單編譯方法。

### 按行解析

在Liber中，大部分情況下，`換行` 即爲 `語句` 的終結。

以一行 `對話` 爲例:   

```liber
馬克吐溫 「寫作很簡單，你所要做的只有把不正確的詞都劃掉。」
```

這句 `對話` 包含一個 `人名`，一個 `對話`， `分隔符` 只有 `空格` 和 `直角引號「」`。  
因此，使用了這樣的正則表達式來匹配並解析——

```regex
(?P<人名>.+?) +「(?P<對話>.*?)」
```


> <small>《優秀的語言是不需要詞法分析的》  
> 前幾天我面試一個**編程語言**，連續幾個專業問題它都沒答上來。  
> 尷尬之餘，我問它「你沒有理想嗎？你現在最渴望的事情是什麼？」  
> **編程語言**轉悠着大眼睛，不假思索道「找一個詞法分析器！」 </small> 


這樣一來 `馬克吐溫` 的名言就會被解析爲字典對象 `{'人名': '马克吐温', '對話': '寫作很簡單，你所要做的只有把不正確的詞都劃掉。'}` 。

因爲對話中還可能含有 `表情`，所以得在中間加上——

```regex
(?P<人名>.+?) +(\((?P<表情>.+?)\))? *「(?P<對話>.*?)」
```

這樣一來就足夠解析樣例中 `潘大爺` 的話語了。

```liber
潘大爺 (笑)「來吧，和我一起，去到地上！」
```

可以解析爲字典對象 `{'人名': '潘大爺', '表情': '笑', '对话': '來吧，和我一起，去到地上！'}`

之後無論加入再多特性，只要屬於三型文法，就可以統統塞進去。

### 類型識別

使用每一個正則表達式對應每一種語句類型。

編譯器在讀入一行時，對每個正則表達式進行匹配。   
如果可以匹配多個則拋出編譯錯誤，如果無法匹配則使用默認類型 `旁白` 。

### 遞歸結構

如果把大量語法都塞進一個正則表達式裏，表達式就會變得冗長，維護就會變得困難。   

因此將複雜的正則表達式組織爲字典，像是——
```python
'....(?P<元素1>).....(?P<元素2>)....': {
    '子樹': {
        '元素2': {
            '?P<小元素1>...?P<小元素2>....': None
        }
    }
},
```
使用遞歸的正則匹配——樣例中先提取出兩個元素，再從第二個元素中提取出小元素們。

### 預處理

有時，`對話` 中可能包含 `換行` 。

```liber
莎士比亞 「戰爭將銅像推翻，
        內訌將城市化爲一片廢墟。」
```

預處理需要將需要續行的情況連成一行。   
因此設置了用於預處理的 `續行組` 。如果當前行能匹配到 `續行組` 中的任意正則表達式，就把下一行加入當前行。

在本例中，需要續行的情況是對話的 `直角引號` 還沒有閉合，因此 `續行組` 有正則表達式 `缺少右引號的對話` ，像是這樣——

```regex
(?P<人名>.+?) +(\((?P<表情>.+?)\))? *「([^」]*)
```

因爲現代漢語中不允許出現 `「「」」` 的引號嵌套，因此可以在遇到第一個 `」` 時直接判定閉合。

### 編譯樣例

```liber
> BG 機房.png
排成列的高過人的金屬箱子的微光，讓黑暗的空間浸染上了青色。
Librian 6，似乎是被這樣稱呼的。
儘管嗡嗡的機械噪聲從耳膜的左邊穿到右邊，又從右邊穿到左邊，像是劣質的鐘錶一樣描述着時間的流逝。但時間就像是反反覆覆地停止了一樣。
潘大爺 (嘆)「美妙，真是美妙。」
不如說，時間不停止的話就是極大的失禮。
潘大爺 (笑)「把我的理論獻給你吧………不，到現在爲止還剩什麼理論呢……」
潘大爺 (笑)「來吧，和我一起，去到地上！」
沒有回應，因爲自始至終這個狹長的空間裏只有一個人。如果他不回應自己的話，就一定沒有誰會回應他了。
青色的光像是風中的火，頻繁而隨機地稍稍淡下又變得更強，也許有人會不禁懷疑電路是不是出了故障…………
…………又像是裝可愛的女兒眨着俏皮的眼睛。
# 這是隨便編的……本來想隨便寫幾句程序的哲理體現一下潘大爺的厲害，結果就變成了小說23333
```

結果:

```python
{'類型': '函數調用', '原文': 'BG 機房.png', '函數': 'BG', '參數表': [{'a': '機房.png'}]}
{'類型': '旁白', '旁白': '排成列的高過人的金屬箱子的微光，讓黑暗的空間浸染上了青色。'}
{'類型': '旁白', '旁白': 'Librian 6，似乎是被這樣稱呼的。'}
{'類型': '旁白', '旁白': '儘管嗡嗡的機械噪聲從耳膜的左邊穿到右邊，又從右邊穿到左邊，像是劣質的鐘錶一樣描述着時間的流逝。但時 間就像是反反覆覆地停止了一樣。'}
{'類型': '人物對話', '名': '潘大爺', '代': None, '特效': None, '顏': '嘆', '語': '美妙，真是美妙。'}
{'類型': '旁白', '旁白': '不如說，時間不停止的話就是極大的失禮。'}
{'類型': '人物對話', '名': '潘大爺', '代': None, '特效': None, '顏': '笑', '語': '把我的理論獻給你吧………不，到現在爲止還剩什麼理論呢……'}
{'類型': '人物對話', '名': '潘大爺', '代': None, '特效': None, '顏': '笑', '語': '來吧，和我一起，去到地上！'}
{'類型': '旁白', '旁白': '沒有回應，因爲自始至終這個狹長的空間裏只有一個人。如果他不回應自己的話，就一定沒有誰會回應他了。'}
{'類型': '旁白', '旁白': '青色的光像是風中的火，頻繁而隨機地稍稍淡下又變得更強，也許有人會不禁懷疑電路是不是出了故障…………'}
{'類型': '旁白', '旁白': '…………又像是裝可愛的女兒眨着俏皮的眼睛。'}
{'類型': '註釋', '註釋': ' 這是隨便編的……本來想隨便寫幾句程序的哲理體現一下潘大爺的厲害，結果就變成了小說23333'}
```